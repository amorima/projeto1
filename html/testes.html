<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filtro de Viagens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .accessibility-options { max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 0.5rem; border-radius: 0.375rem; }
        .card-tag { display: inline-block; background-color: #e0e7ff; color: #4f46e5; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.375rem; margin-right: 0.25rem; margin-bottom: 0.25rem; }
    </style>
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto max-w-7xl bg-white rounded-lg shadow-lg p-6 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Encontre a sua Próxima Viagem</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            <div>
                <label for="origem" class="block text-sm font-medium text-gray-700 mb-1">Origem</label>
                <select id="origem" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecione a origem</option>
                </select>
            </div>

            <div>
                <label for="destino" class="block text-sm font-medium text-gray-700 mb-1">Destino</label>
                <select id="destino" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecione o destino</option>
                </select>
            </div>

            <div>
                <label for="data" class="block text-sm font-medium text-gray-700 mb-1">Data (Opcional)</label>
                <input type="date" id="data" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div>
                <label for="tipoTurismo" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Turismo</label>
                <select id="tipoTurismo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Qualquer tipo</option>
                </select>
            </div>

            <div class="md:col-span-2 lg:col-span-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Necessidades de Acessibilidade</label>
                <div id="acessibilidadeContainer" class="accessibility-options bg-white">
                </div>
            </div>

             <div class="flex items-end space-x-2 md:col-span-2 lg:col-span-1">
                <button id="filtrarBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">Filtrar</button>
                <button id="resetBtn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">Limpar</button>
            </div>
        </div>

        <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-4">Destinos Encontrados</h2>
        <div id="resultados" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <p id="loadingMessage" class="text-gray-500 col-span-full">A carregar dados...</p>
            <p id="errorMessage" class="text-red-500 hidden col-span-full">Erro ao carregar dados. Verifique se o ficheiro /db.json existe e está acessível.</p>
            <p id="noResults" class="text-gray-500 hidden col-span-full">Nenhum destino encontrado com os filtros selecionados.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const origemSelect = document.getElementById('origem');
            const destinoSelect = document.getElementById('destino');
            const tipoTurismoSelect = document.getElementById('tipoTurismo');
            const acessibilidadeContainer = document.getElementById('acessibilidadeContainer');
            const resultadosDiv = document.getElementById('resultados');
            const filtrarBtn = document.getElementById('filtrarBtn');
            const resetBtn = document.getElementById('resetBtn');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const noResults = document.getElementById('noResults');

            let dbData = null;

            async function loadData() {
                try {
                    const response = await fetch('/db.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    dbData = await response.json();
                    populateFilters();
                    displayResultados(dbData.destinos);
                    loadingMessage.classList.add('hidden');
                } catch (error) {
                    console.error('Erro ao carregar db.json:', error);
                    loadingMessage.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                }
            }

            function populateFilters() {
                if (!dbData) return;

                const aeroportos = dbData.aeroportos || [];
                const destinos = dbData.destinos || [];
                const tiposTurismo = dbData.tiposTurismo || [];
                const acessibilidadeOptions = dbData.acessibilidade || [];

                const uniqueAeroportos = [...new Map(aeroportos.map(item =>
                    [`${item.cidade} (${item.codigo})`, item])).values()];

                uniqueAeroportos.sort((a, b) => a.cidade.localeCompare(b.cidade));

                uniqueAeroportos.forEach(aero => {
                    const optionOrigem = document.createElement('option');
                    optionOrigem.value = `${aero.cidade} (${aero.codigo})`;
                    optionOrigem.textContent = `${aero.cidade} (${aero.codigo})`;
                    origemSelect.appendChild(optionOrigem);

                    const optionDestino = document.createElement('option');
                    optionDestino.value = aero.cidade;
                    optionDestino.textContent = `${aero.cidade} (${aero.codigo})`;
                    destinoSelect.appendChild(optionDestino);
                });

                tiposTurismo.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo;
                    option.textContent = tipo;
                    tipoTurismoSelect.appendChild(option);
                });

                acessibilidadeOptions.forEach(opcao => {
                    const div = document.createElement('div');
                    div.classList.add('flex', 'items-center', 'mb-1');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `acc-${opcao.replace(/\s+/g, '-')}`;
                    checkbox.value = opcao;
                    checkbox.classList.add('h-4', 'w-4', 'text-indigo-600', 'border-gray-300', 'rounded', 'focus:ring-indigo-500');
                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = opcao;
                    label.classList.add('ml-2', 'block', 'text-sm', 'text-gray-900');
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    acessibilidadeContainer.appendChild(div);
                });
            }

            function displayResultados(destinosFiltrados) {
                resultadosDiv.innerHTML = '';
                noResults.classList.add('hidden');
                errorMessage.classList.add('hidden');
                 if (!loadingMessage.classList.contains('hidden')) {
                    loadingMessage.classList.add('hidden');
                 }


                if (destinosFiltrados.length === 0) {
                    noResults.classList.remove('hidden');
                    return;
                }

                destinosFiltrados.forEach(destino => {
                    const card = document.createElement('div');
                    card.classList.add('bg-white', 'rounded-lg', 'shadow', 'p-4', 'flex', 'flex-col', 'justify-between');

                    let acessibilidadeHtml = '';
                    if (destino.acessibilidade && destino.acessibilidade.length > 0) {
                        acessibilidadeHtml = destino.acessibilidade.map(acc => `<span class="card-tag">${acc}</span>`).join('');
                    } else {
                         acessibilidadeHtml = '<span class="text-xs text-gray-500">Nenhuma especificada</span>';
                    }


                    let turismoHtml = '';
                     if (destino.tiposTurismo && destino.tiposTurismo.length > 0) {
                        turismoHtml = destino.tiposTurismo.map(tipo => `<span class="card-tag">${tipo}</span>`).join('');
                    } else {
                         turismoHtml = '<span class="text-xs text-gray-500">Nenhum especificado</span>';
                    }


                    card.innerHTML = `
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${destino.cidade}, ${destino.pais}</h3>
                            <p class="text-sm text-gray-600 mb-2">Aeroporto Principal: ${destino.aeroporto}</p>

                            <div class="mt-2 mb-3">
                                <p class="text-xs font-medium text-gray-500 mb-1">Tipos de Turismo:</p>
                                <div class="flex flex-wrap">
                                    ${turismoHtml}
                                </div>
                            </div>
                             <div class="mt-2">
                                <p class="text-xs font-medium text-gray-500 mb-1">Acessibilidade Geral:</p>
                                <div class="flex flex-wrap">
                                   ${acessibilidadeHtml}
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">

                        </div>
                    `;
                    resultadosDiv.appendChild(card);
                });
            }

            function filtrarDestinos() {
                if (!dbData) return;

                const destinoSelecionado = destinoSelect.value;
                const tipoTurismoSelecionado = tipoTurismoSelect.value;
                const acessibilidadesSelecionadas = Array.from(acessibilidadeContainer.querySelectorAll('input[type="checkbox"]:checked'))
                                                       .map(cb => cb.value);

                const resultadosFiltrados = dbData.destinos.filter(destino => {
                    const matchDestino = !destinoSelecionado || destino.cidade === destinoSelecionado;
                    const matchTipoTurismo = !tipoTurismoSelecionado || (destino.tiposTurismo && destino.tiposTurismo.includes(tipoTurismoSelecionado));
                    const matchAcessibilidade = acessibilidadesSelecionadas.length === 0 || (destino.acessibilidade && acessibilidadesSelecionadas.every(acc => destino.acessibilidade.includes(acc)));

                    return matchDestino && matchTipoTurismo && matchAcessibilidade;
                });

                displayResultados(resultadosFiltrados);
            }

             function resetFilters() {
                origemSelect.value = '';
                destinoSelect.value = '';
                document.getElementById('data').value = '';
                tipoTurismoSelect.value = '';
                acessibilidadeContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                if(dbData) {
                    displayResultados(dbData.destinos);
                } else {
                     resultadosDiv.innerHTML = '';
                     loadingMessage.classList.remove('hidden');
                     errorMessage.classList.add('hidden');
                     noResults.classList.add('hidden');
                     loadData(); // Tenta carregar novamente se falhou
                }
            }


            filtrarBtn.addEventListener('click', filtrarDestinos);
            resetBtn.addEventListener('click', resetFilters);

            loadData();
        });
    </script>

    <script type="module" src="../js/init.js" defer></script>
</body>
</html>
